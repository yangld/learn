/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var S=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var q=(n,t)=>{for(var e in t)S(n,e,{get:t[e],enumerable:!0})},Z=(n,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of J(t))!K.call(n,a)&&a!==e&&S(n,a,{get:()=>t[a],enumerable:!(s=W(t,a))||s.enumerable});return n};var Q=n=>Z(S({},"__esModule",{value:!0}),n);var he={};q(he,{default:()=>le});module.exports=Q(he);var C=require("obsidian");var R=require("obsidian");var u="\xD8",d="text",g="default",f="complete",A={groups:{default:{name:g,marks:" ",complete:!1,removeExpr:"",appendDateFormat:"",registerCommand:!1,useContextMenu:!1},complete:{name:f,marks:"xX",complete:!0,removeExpr:"",appendDateFormat:"",registerCommand:!1,useContextMenu:!1}},markCycle:"",collectionEnabled:!1,previewClickModal:!0,contextMenu:{markTask:!0,resetTask:!1,collectTasks:!0},debug:!1,version:{major:0,minor:0,patch:0}},$={name:g,marks:"",complete:!1,removeExpr:"",appendDateFormat:"",registerCommand:!1,useContextMenu:!1};var N={areaHeading:"## Log",removeCheckbox:!1},P={useContextMenu:!1,completedMarks:"",incompleteMarks:"",marks:{},removeExpr:{},undoExpr:{},areaHeadings:[],headingToMark:{}},O={completedAreaHeader:"## Log",removeExpression:"",appendDateFormat:"",appendRemoveAllTasks:!1,incompleteTaskValues:" ",onlyLowercaseX:!1,supportCanceledTasks:!0,previewOnClick:!1,rightClickComplete:!1,rightClickMark:!1,rightClickMove:!1,rightClickResetTask:!1,rightClickResetAll:!1,rightClickToggleAll:!1,completedAreaRemoveCheckbox:!1};var F=require("obsidian");var m={constructSettings:ee,createSettingsGroup:L,sanitize:H,sanitizeMarks:v,moveGroup:b};function v(n){let t=Array.from(new Set(n));return t.sort(),t.join("").replace(u,"")}function H(n,t){n.tc.logDebug("sanitize begin",t);let e=!1;t.markCycle&&(t.markCycle=[...new Set(t.markCycle)].join("")),Object.entries(t.groups).filter(([a,o])=>a!==o.name).forEach(([a,o])=>{e=!0,t.groups[o.name]?(console.warn(`(TC) Group named ${o.name} already exists. Reverting group name to ${a}`),o.name=a):b(t.groups,a,o.name)}),D(t.groups[d])&&(e=!0,t.groups[d].marks=u);let s=Object.entries(t.groups).filter(([a,o])=>!D(o));if(s.length>1){e=!0,console.warn(`(TC) There can be only one group for text-only settings (${d}).`),t.groups[d]||(console.info(`(TC) Configuration: renamed group ${s[0][1].name} to ${d}.`),b(t.groups,s[0][1].name,d));let a="",o;Object.entries(t.groups).filter(([r,i])=>!D(i)).filter(([r,i])=>r!==d).forEach(([r,i])=>{[a,o]=oe(a),t.groups[r].marks=o})}else s.length==1&&s[0][1].name!==d&&(console.info(`(TC) Configuration: renamed group ${s[0][1].name} to ${d}.`),b(t.groups,s[0][1].name,d));t.groups[d]&&t.groups[d].collection&&delete t.groups[d].collection,e&&new F.Notice("(TC) Configuration settings were modified. See console for details."),n.tc.logDebug("sanitize end",t)}async function ee(n,t){return t.version?await te(n,t):await se(n,t)}async function te(n,t){let e={...A,...t};H(n,e);let s=_(n.manifest.version);return ae(s,e.version)===0||(e.version=s,await n.saveData(e)),e}async function se(n,t){console.info("(TC) Migrating 0.x settings to the current version"),console.debug("0.x settings",t);let e={...O,...t},s=JSON.parse(JSON.stringify(A));s.previewClickModal=e.previewOnClick,s.contextMenu.markTask=e.rightClickMark,s.contextMenu.resetTask=e.rightClickResetTask,s.groups[f].useContextMenu=e.rightClickComplete;let a;return a="x",e.onlyLowercaseX||(a+="X"),e.supportCanceledTasks&&(a+="-"),s.groups[f].marks=v(a),s.groups[f].appendDateFormat=e.appendDateFormat,s.groups[f].removeExpr=e.removeExpression,a=e.incompleteTaskValues,s.groups[g].marks=v(a),e.appendRemoveAllTasks&&(s.groups[g].appendDateFormat=e.appendDateFormat,s.groups[g].removeExpr=e.removeExpression),s.collectionEnabled=!0,s.contextMenu.collectTasks=e.rightClickMove||!1,t.cycleTaskValues&&(s.markCycle=t.cycleTaskValues,t.incompleteTaskValuesRow2&&L(s.groups,"group-2",{marks:v(t.incompleteTaskValuesRow2),appendDateFormat:t.appendTextFormatMarkRow2}),t.appendTextFormatMark&&(s.groups[g].appendDateFormat=t.appendTextFormatMark),t.appendTextFormatAppend&&L(s.groups,d,{marks:u,appendDateFormat:t.appendTextFormatAppend,useContextMenu:t.rightClickAppend}),console.log(s.groups),s.collectionEnabled=!1),s.collectionEnabled&&(s.groups[f].collection={areaHeading:e.completedAreaHeader,removeCheckbox:e.completedAreaRemoveCheckbox}),s.version=_(n.manifest.version),n.tc.logDebug("migrated settings",s),await n.saveData(s),s}function L(n,t,e){n[t]={...$,name:t,...e},n[t].marks===""&&(n[t].marks=u)}function _(n){let t=n.split(".");return{major:Number(t[0]),minor:Number(t[1]),patch:Number(t[2])}}function ae(n,t){return n.major===t.major?n.minor===t.minor?n.patch-t.patch:n.minor-t.minor:n.major-t.major}function D(n){return n&&n.marks!==""&&n.marks!==u}function b(n,t,e){!n||!t||!e||e===t||(n[e]?console.warn(`(TC) Can not move group, ${e} already exists`):(n[t].name=e,n[e]=n[t],delete n[t]))}function oe(n){let t=0;do{let e=String.fromCharCode(9812+Math.random()*20);if(n.indexOf(e)<0)return n+=e,[n,e];t++}while(t<10);return[n,String.fromCharCode(9447)]}var re=/^(Y|D|M|H|h|m)+$/,ie=/(\[[^[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|N{1,5}|YYYYYY|YYYYY|YYYY|YY|y{2,4}|yo?|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g;var M=class{constructor(){this.anyListItem=new RegExp(/^([\s>]*- )([^\\[].*)$/);this.anyTaskMark=new RegExp(/^([\s>]*- \[)(.)(\] .*)$/);this.anyText=new RegExp(/^([\s>]*)(.*)$/);this.blockQuote=new RegExp(/^(\s*>[\s>]*)(.*)$/);this.blockRef=new RegExp(/^(.*?)( \^[A-Za-z0-9-]+)?$/);this.continuation=new RegExp(/^( {2,}|\t)/);this.stripTask=new RegExp(/^([\s>]*-) \[.\] (.*)$/)}init(t){this.settings=t,this.cache=JSON.parse(JSON.stringify(P)),this.cache.useContextMenu=t.contextMenu.markTask||t.contextMenu.resetTask,Object.values(t.groups).forEach(e=>this.cacheTaskSettings(e,this.cache)),this.settings.collectionEnabled&&(this.cache.areaHeadings=[...Object.keys(this.cache.headingToMark)],this.cache.areaHeadings.sort()),this.cache.completedMarks=m.sanitizeMarks(this.cache.completedMarks),this.cache.incompleteMarks=m.sanitizeMarks(this.cache.incompleteMarks),this.logDebug("configuration read",this.settings,this.cache)}logDebug(t,...e){(!this.settings||this.settings.debug)&&console.debug("(TC) "+t,...e)}cacheTaskSettings(t,e){t.marks.split("").forEach(s=>{if(e.marks[s]){let a=e.marks[s].name;console.warn(`Two groups of settings contain ${s}: ${a} and ${t.name}. Using ${a}`)}else{if(e.marks[s]=t,e.useContextMenu==e.useContextMenu||t.useContextMenu,t.removeExpr){let a=G(t.removeExpr);e.removeExpr[t.name]=a}if(t.appendDateFormat){let a=U(t.appendDateFormat);e.undoExpr[t.name]=a}t.collection&&t.collection.areaHeading&&(e.headingToMark[t.collection.areaHeading]?e.headingToMark[t.collection.areaHeading]+=s:e.headingToMark[t.collection.areaHeading]=s),s!==u&&(t.complete?e.completedMarks+=s:e.incompleteMarks+=s)}})}markInCycle(t,e,s=[]){let a=t.split(`
`);for(let o of s){let r=this.anyTaskMark.exec(a[o]),i=this.anyListItem.exec(a[o]);if(r){let c=r[2],l=this.settings.markCycle.indexOf(c),p=this.settings.markCycle.length,k=e==1?(l+1)%p:(l+p-1)%p;a[o]=this.doMarkTask(a[o],c,this.settings.markCycle[k])}else i&&i[2]&&(a[o]=this.updateLineText(`${i[1]}[ ] ${i[2]}`,this.settings.markCycle[0]))}return a.join(`
`)}markSelectedTask(t,e,s=[]){let a=t.split(`
`);for(let o of s)a[o]=this.updateLineText(a[o],e);return a.join(`
`)}updateLineText(t,e){if(e==="Backspace")return this.doRemoveTask(t);if(e===""&&(e=u),e===u&&this.cache.marks[u])return this.doAppendText(t);let s=this.anyTaskMark.exec(t);if(s){let o=s[2];return this.doMarkTask(t,o,e)}let a=this.anyListItem.exec(t);return a&&a[2]?this.updateLineText(`${a[1]}[ ] ${a[2]}`,e):(this.logDebug("not a task or list item %s",t),t)}doAppendText(t,e=!0){let s="",a=t.endsWith("  "),o=this.blockRef.exec(t);o&&o[2]&&(t=o[1],s=o[2]);let r=this.cache.undoExpr[d];if(r&&(t=t.replace(r,"")),e){let i=this.cache.removeExpr[d];i&&(t=t.replace(i,""));let c=this.settings.groups[d].appendDateFormat;c&&(t.endsWith(" ")||(t+=" "),t+=(0,R.moment)().format(c))}return t=t.replace(/\s*$/,s),a&&(t+="  "),this.logDebug("text updated",t),t}doMarkTask(t,e,s){this.logDebug("mark task",t);let a=this.cache.marks[e]?.name||g,o=this.cache.marks[s]?.name||g;t=t.replace(this.anyTaskMark,`$1${s}$3`);let r="",i=t.endsWith("  "),c=this.blockRef.exec(t);c&&c[2]&&(t=c[1],r=c[2]);let l=this.cache.undoExpr[a];l&&(t=t.replace(l,""));let p=this.cache.removeExpr[o];p&&(t=t.replace(p,""));let k=this.settings.groups[o].appendDateFormat;return k&&(t.endsWith(" ")||(t+=" "),t+=(0,R.moment)().format(k)),t=t.replace(/\s*$/,r),i&&(t+="  "),this.logDebug("task marked",t),t}doRemoveTask(t){return t.replace(this.stripTask,"$1 $2")}moveAllTasks(t){if(this.cache.areaHeadings.length==0)return t;let e=[],s=[],a=this.scan(t,e,s),o=this.move(e,a,s,0);for(let r=0;r<s.length;r++){let[i,c]=s[r].split("%:%"),l=Number(c);a[i].blocks[l].existing=this.move(a[i].blocks[l].existing,a,s,r,this.cache.headingToMark[i])}return o.flatMap(r=>{let i=r.match(/%%--TC--(.*)--(\d+)--%%/);if(i){let c=i[1],l=Number(i[2]);return a[c].blocks[l].newTasks.concat(...a[c].blocks[l].existing)}return r}).join(`
`)}scan(t,e,s){let a=t.split(`
`);this.ensureHeadings(a);let o={},r=null;for(let i of a){let c=i.trim();if(i.startsWith("#")&&V(this.cache.areaHeadings,c)){e.push(i);let l=this.createCompletionArea(c,o);r=o[c].blocks[l].existing,e.push(`%%--TC--${c}--${l}--%%`),s.push(`${c}%:%${l}`)}else r&&(i.startsWith("#")||i.trim()==="---")?(r=null,e.push(i)):r?r.push(i):e.push(i)}return o}move(t,e,s,a,o){let r=[],i=null,c=null,l=!1;for(let p of t){if(c&&this.isContinuation(p,l)){c.push(p);continue}if(c){let T=this.cache.marks[i].collection.areaHeading,X=this.findNextSection(T,s,a);c.forEach(z=>e[T].blocks[X].newTasks.push(z)),i=null,c=null,l=!1}if(p.startsWith("%%--TC--")){a=t.indexOf(p),r.push(p);continue}let k=this.anyTaskMark.exec(p);if(k){let T=k[2];o&&o.indexOf(T)>=0?r.push(p):this.isCollected(T)?(this.removeCheckbox(T)&&(p=this.doRemoveTask(p)),i=T,c=[],c.push(p),l=this.isCallout(p)):r.push(p)}else r.push(p)}return r}findNextSection(t,e,s){let a=!1;for(let o=s;!a||o!=s;o++)if(o==e.length&&(o=0,a=!0),e[o].startsWith(t)){let[r,i]=e[o].split("%:%");return Number(i)}}createCompletionArea(t,e){return e[t]||(e[t]={blocks:[]}),e[t].blocks.push({existing:[],newTasks:[]}),e[t].blocks.length-1}ensureHeadings(t){this.cache.areaHeadings.forEach(e=>{V(t,e)||(t[t.length-1].trim()!==""&&t.push(""),t.push(e),t.push(""))})}isCollected(t){return this.cache.marks[t]&&this.cache.marks[t].collection&&this.cache.marks[t].collection.areaHeading}removeCheckbox(t){return this.cache.marks[t]&&this.cache.marks[t].collection&&this.cache.marks[t].collection.removeCheckbox}isCallout(t){return this.blockQuote.test(t)}isContinuation(t,e){if(e){let s=this.blockQuote.exec(t);if(s)return s[1].endsWith(">")||s[1].endsWith("  ")||s[1].endsWith("	")}return this.continuation.test(t)}};function V(n,t){return n.find(e=>e===t)}var j={tryCompleteRegex:ne,tryIncompleteRegex:ce,tryUndoRegex:U,tryRemoveTextRegex:G};function ne(n){return new RegExp(`^([\\s>]*- \\[)[${n}](\\] .*)$`)}function ce(n){return new RegExp(`^([\\s>]*- \\[)[${n}](\\] .*)$`)}function G(n){return n?new RegExp(n,"g"):null}function U(n){let t=n.match(ie);for(let s=0,a=t.length;s<a;s++){let o=t[s];re.test(o)?t[s]=o.replace(/YYYY/g,"\\d{4}").replace(/YY/g,"\\d{2}").replace(/DD/g,"\\d{2}").replace(/D/g,"\\d{1,2}").replace(/MMM/g,"[A-Za-z]{3}").replace(/MM/g,"\\d{2}").replace(/M/g,"\\d{1,2}").replace(/HH/g,"\\d{2}").replace(/H/g,"\\d{1,2}").replace(/hh/g,"\\d{2}").replace(/h/g,"\\d{1,2}").replace(/mm/g,"\\d{2}").replace(/m/g,"\\d{1,2}"):o.match(/\[[\s\S]/)?t[s]=Y(o.replace(/^\[|\]$/g,"")):t[s]=Y(o)}let e=`\\s*${t.join("")}\\s*`;return new RegExp(e+"( \\^[A-Za-z0-9-]+)?$")}function Y(n){return n.replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/\[/g,"\\[").replace(/\]/g,"\\]")}var h=require("obsidian");var w=class extends h.PluginSettingTab{constructor(e,s,a){super(e,s);this.markInputCache={};this.otherInputCache={};this.plugin=s,this.tc=a}save(){m.sanitize(this.plugin,this.newSettings),this.tc.init(this.newSettings),this.plugin.saveSettings(),new h.Notice("(TC) Configuration saved")}hide(){this.save()}display(){this.newSettings=JSON.parse(JSON.stringify(this.tc.settings)),this.drawElements()}drawElements(){this.containerEl.empty(),this.containerEl.addClass("task-collector-settings"),new h.Setting(this.containerEl).setHeading().setName("Task Collector"),new h.Setting(this.containerEl).setName("Save settings").setClass("task-collector-save-reset").addButton(e=>e.setIcon("reset").setTooltip("Reset to previously saved (or generated) values").onClick(()=>{this.newSettings=JSON.parse(JSON.stringify(this.tc.settings)),this.display(),new h.Notice("(TC) Configuration reset")})).addButton(e=>{e.setIcon("save").setTooltip("Save current values").onClick(()=>{this.save()}),this.saveButton=e.buttonEl}),new h.Setting(this.containerEl).setName("Task Collection").setDesc("Enable task collection (additional task group settings when enabled)").addToggle(e=>e.setValue(this.newSettings.collectionEnabled).onChange(async s=>{let a=s!=this.newSettings.collectionEnabled;this.newSettings.collectionEnabled=s,a&&this.drawElements()})),new h.Setting(this.containerEl).setName("Define task mark cycle").setDesc("Specify characters (as a string) for Previous/Next commands").addText(e=>e.setPlaceholder("").setValue(this.newSettings.markCycle).onChange(async s=>{this.newSettings.markCycle=[...new Set(s)].join("")})),new h.Setting(this.containerEl).setHeading().setName("Task Groups"),this.containerEl.createEl("p",{text:"Task collector configures tasks in groups. Each group can be associated with one or more task marks ('x' or '>'). The default group configuration will apply to any mark not otherwise assigned to a group."}),this.containerEl.createEl("p",{text:"Marks that you define within the following groups appear in the selection modal. Those marks that 'complete' a task will appear in the top row."}),this.groupList=this.containerEl.createEl("dl"),this.showTaskGroups(),new h.Setting(this.containerEl).setClass("tc-create-task-group").addButton(e=>e.setTooltip("Add a new task group").setButtonText("+").onClick(()=>{let s=`group-${Object.values(this.newSettings.groups).length}`;m.createSettingsGroup(this.newSettings.groups,s,{}),this.showTaskGroups()})),new h.Setting(this.containerEl).setHeading().setName("Menus and Modals"),this.containerEl.createEl("p",{text:"Task Collector creates commands that can be bound to hotkeys or accessed using slash commands for marking tasks. The following settings add right click context menu items for those commands."}),new h.Setting(this.containerEl).setName("Prompt on checkbox click in Reading or Live preview mode").setDesc("When you click a checkbox, display a panel that allows you to select (with mouse or keyboard) the value to assign.").addToggle(e=>e.setValue(this.newSettings.previewClickModal).onChange(async s=>{this.newSettings.previewClickModal=s})),new h.Setting(this.containerEl).setName("Add '(TC) Mark task' menu item").setDesc("Add an item to the right-click menu to mark the task on the current line (or within the current selection). This menu item will trigger a quick pop-up modal to select the desired mark value.").addToggle(e=>e.setValue(this.newSettings.contextMenu.markTask).onChange(async s=>{this.newSettings.contextMenu.markTask=s})),new h.Setting(this.containerEl).setName("Add `(TC) Collect Tasks` menu item").setDesc("Add an item to the right-click menu to collect tasks (based on task configuration).").addToggle(e=>e.setValue(this.newSettings.contextMenu.collectTasks).onChange(async s=>{this.newSettings.contextMenu.collectTasks=s})),new h.Setting(this.containerEl).setHeading().setName("Other settings"),new h.Setting(this.containerEl).setName("Debug").setDesc("Enable debug messages").addToggle(e=>e.setValue(this.newSettings.debug).onChange(async s=>{this.newSettings.debug=s}))}showTaskGroups(){this.markInputCache={},this.otherInputCache={},this.groupList.empty(),this.clearButtonErrors(),this.createGroupItem(this.newSettings.groups[g]),Object.values(this.newSettings.groups).filter(e=>e.name!=g).forEach(e=>{this.createGroupItem(e)})}createGroupItem(e){let s=this.groupList.createEl("dt"),a=this.groupList.createEl("dd"),o=new h.Setting(s).setName("Group name").setDesc("Name for this group").setClass("task-group-name");if(e.name===d&&o.addExtraButton(r=>{r.setIcon("info").setTooltip("This is a special group that supports appending text to arbitrary lines of text").setDisabled(!0)}),o.addText(r=>{r.setPlaceholder(f).setValue(e.name).setDisabled(e.name===g).onChange((0,h.debounce)(i=>{let c=this.newSettings.groups[i];i?c&&c!=e?(r.inputEl.addClass("data-value-error"),r.inputEl.setAttribute("aria-label","This name is already used by another group")):(r.inputEl.removeClass("data-value-error"),r.inputEl.removeAttribute("aria-label"),m.moveGroup(this.newSettings.groups,e.name,i),i===d&&(e.marks=u,this.drawElements())):(r.inputEl.addClass("data-value-error"),r.inputEl.setAttribute("aria-label","A group name is required.")),this.testForErrors()},50,!0)),this.addToCache(r.inputEl,"name-setting")}),o.addExtraButton(r=>{r.setIcon(e.name===g?"info":"trash").setTooltip(e.name===g?"Default task settings":"Delete this group").setDisabled(e.name===g).onClick(async()=>{delete this.newSettings.groups[e.name],this.showTaskGroups()})}),e.name===g?o.controlEl.addClass("default-group"):e.name===d&&o.controlEl.addClass("text-only-group"),e.name!==d){let r=new h.Setting(a).setName("Task marks").setClass("task-marks");e.name!==g?(r.addToggle(i=>{i.setValue(e.complete),i.setTooltip("If enabled, this group represents completed items. Completed items appear in the top row of the selection menu.").onChange(async c=>{e.complete=c})}),r.setDesc("Set one or marks associated with this group as a string. e.g. '>?!'. Use a space for unmarked tasks. Enable the toggle if this group represents completed tasks.")):r.setDesc("Set one or marks associated with this group as a string. e.g. '>?!'. Use a space for unmarked tasks. "),r.addText(i=>{i.setPlaceholder("xX").onChange((0,h.debounce)(c=>{let l=m.sanitizeMarks(c);l!=c&&(i.inputEl.value=l),l!=e.marks&&(this.removeMarks(e.marks,i.inputEl),e.marks=l,r.controlEl.setAttribute("marks",e.marks),this.findDuplicates(i.inputEl))},50,!0)),e.marks=m.sanitizeMarks(e.marks),i.setValue(e.marks),r.controlEl.setAttribute("marks",e.marks),this.findDuplicates(i.inputEl)})}new h.Setting(a).setName(`Append date to ${this.getDescription(e)}`).setDesc(`Append today's date in the given moment.js format to the end of the ${this.getDescription(e)}`).addMomentFormat(r=>{r.setPlaceholder("YYYY-MM-DD").setValue(e.appendDateFormat).onChange((0,h.debounce)(i=>{try{let c=(0,h.moment)().format(i);r.inputEl.removeClass("data-value-error"),r.inputEl.setAttribute("aria-label",c),e.appendDateFormat=i}catch{r.inputEl.addClass("data-value-error"),r.inputEl.setAttribute("aria-label","An error occurred parsing this moment string. See log for details."),console.error(`Error parsing specified date format for ${e.name}: ${i}`)}this.testForErrors()},200,!0)),this.addToCache(r.inputEl,"moment-format")}),new h.Setting(a).setName(`Remove text matching pattern from ${this.getDescription(e)}`).setDesc(`Text matching this regular expression will be removed from ${this.getDescription(e)}. Be careful! Test your expression first. The global flag ('g') is used for a per-line match.`).addText(r=>r.setPlaceholder(" #(todo|task)").setValue(e.removeExpr).onChange((0,h.debounce)(i=>{try{j.tryRemoveTextRegex(i),e.removeExpr=i,this.tc.logDebug("remove regex",e.name,e.removeExpr)}catch{console.error(`Error parsing specified text replacement regular expression for ${e.name}: ${i}`)}},50,!0))),new h.Setting(a).setName("Register '(TC) Mark with... ' command").setDesc(e.name===d?"A command will be registered to append text to selected lines":"A command will be registered for each mark in the group.").addToggle(r=>r.setValue(e.registerCommand).onChange(i=>{e.registerCommand=i})),new h.Setting(a).setName("Add '(TC) Mark with... ' menu item").setDesc("A right-click menu item will be added for each mark in the group.").addToggle(r=>r.setValue(e.useContextMenu).onChange(async i=>{e.useContextMenu=i})),this.newSettings.collectionEnabled&&e.name!==d&&(e.collection||(e.collection=JSON.parse(JSON.stringify(N))),new h.Setting(a).setName("Area heading").setClass("area-heading").setDesc("Marked tasks will be collected and moved under the specified heading. Task collection for a group only occurs when an area heading is configured.").addText(r=>r.setPlaceholder("## Example").setValue(e.collection.areaHeading).onChange(async i=>{e.collection.areaHeading=i})),new h.Setting(a).setName("Remove checkbox").setClass("remove-checkbox").setDesc("When a task is collected, remove the checkbox").addToggle(r=>r.setValue(e.collection.removeCheckbox).onChange(async i=>{e.collection.removeCheckbox=i})))}removeMarks(e,s){let a=e?e.split(""):[];this.tc.logDebug(`removeMarks begin: '${e}'`,this.markInputCache),s.hasClass("no-marks-defined")&&(s.removeClass("no-marks-defined"),s.removeClass("data-value-error"),s.removeAttribute("aria-label")),a.forEach(o=>{if(this.tc.logDebug(`(TC): remove mark '${o}'`,this.markInputCache[o]),this.markInputCache[o]){let r=this.markInputCache[o];r.delete(s),this.tryRemoveConflict(o,s),r.size==1&&r.forEach(i=>this.tryRemoveConflict(o,i))}}),this.tc.logDebug(`removeMarks end: '${e}'`,this.markInputCache)}findDuplicates(e){let s=e.value?e.value.split(""):[];this.tc.logDebug(`findDuplicates begin: '${e.value}'`,s,e,this.markInputCache),s.forEach(a=>{if(this.markInputCache[a]){let o=this.markInputCache[a];o.add(e),o.size>1&&(o.forEach(r=>this.trySetConflict(a,r)),console.error(`(TC) More then one group uses task mark ${this.showMark(a)}`))}else this.markInputCache[a]=new Set,this.markInputCache[a].add(e)}),s.length==0&&(e.addClass("no-marks-defined"),e.addClass("data-value-error"),e.setAttribute("aria-label",this.newSettings.groups[d]?"Must define one or more marks for this group.":`Must define one or more marks for this group. Change the name to '${d}' for special text-only behavior.`),this.tc.logDebug(`findDuplicates end (empty): '${e.value}'`,e,this.markInputCache)),this.tc.logDebug(`findDuplicates end: '${e.value}'`,e,this.markInputCache),this.testForErrors()}trySetConflict(e,s){let a=s.getAttribute("conflict")||"",o=m.sanitizeMarks(a+e);s.setAttribute("conflict",o),s.addClass("data-value-error"),s.setAttribute("aria-label",`More than one task group uses ${this.showMark(o)}`),this.tc.logDebug(`conflicts for '${s.value}': '${this.showMark(o)}'`)}tryRemoveConflict(e,s){if(!s.hasAttribute("conflict"))return;let a=s.getAttribute("conflict").replace(e,"");a.length==0?(s.removeAttribute("conflict"),s.removeClass("data-value-error"),s.removeAttribute("aria-label")):(s.removeAttribute("conflict"),this.trySetConflict(a,s))}getDescription(e){return e.name===d?"selected lines of text":"selected task(s)"}showMark(e){return e==u?"(empty)":e}clearButtonErrors(){this.saveButton.removeClass("data-value-error"),this.saveButton.removeAttribute("aria-label")}testForErrors(){let e=Object.values(this.markInputCache).flatMap(a=>Array.from(a.values())).find(a=>a.hasClass("data-value-error")),s=Object.values(this.otherInputCache).find(a=>a.hasClass("data-value-error"));e||s?(this.saveButton.addClass("data-value-error"),this.saveButton.setAttribute("aria-label","There are configuration errors. Correct those before saving.")):(this.saveButton.removeClass("data-value-error"),this.saveButton.removeAttribute("aria-label"))}addToCache(e,s){let a=Object.values(this.otherInputCache).length;this.otherInputCache[`${s}-${a}`]=e,e.setAttribute("cache-id",`${s}-${a}`)}removeFromCache(e){let s=e.getAttribute("cache-id");s&&delete this.otherInputCache[s]}};var B=require("obsidian");function E(n,t){return new Promise(e=>{let s=new I(n,t);s.onClose=()=>{e(s.chosenMark)},s.open()})}var I=class extends B.Modal{constructor(e,s){super(e);this.taskCollector=s,this.containerEl.id="taskcollector-modal"}onOpen(){let e=this.contentEl.createDiv("taskcollector-selector markdown-preview-view"),s=e.createEl("ul");s.addClass("contains-task-list"),this.addTaskValues(s,this.taskCollector.cache.completedMarks,!0);let a=e.createEl("ul");a.addClass("contains-task-list"),this.addTaskValues(a,this.taskCollector.cache.incompleteMarks,!1);let o=e.createEl("nav"),r=o.createSpan();r.innerHTML="<b>esc</b> to dismiss";let i=o.createSpan();i.innerHTML="<b>bksp</b> to remove <code>[]</code>";let c=this,l=function(p){switch(p.key){case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":case"CapsLock":case"Tab":break;default:c.chosenMark=p.key,p.preventDefault(),p.stopImmediatePropagation(),c.close()}};this.scope.register([],null,l),this.scope.register(["Shift"],null,l)}addTaskValues(e,s,a){let o=this;for(let r of s){let i=e.createEl("li",{cls:"task-list-item "+(r==" "?"":" is-checked"),attr:{"data-task":r}});i.addEventListener("click",function(l){o.chosenMark=r,o.close()});let c=i.createEl("input",{cls:"task-list-item-checkbox",attr:{id:"task-list-item-checkbox-"+r,type:"checkbox",style:"pointer-events: none;"}});r!=" "&&c.setAttribute("checked",""),i.createEl("span",{text:r==" "?"\u2423":r,attr:{style:"pointer-events: none;"}})}}onClose(){this.contentEl.empty()}};var x=class{constructor(t,e){this.app=t,this.taskCollector=e}getCompletedTaskValues(){return this.taskCollector.cache.completedMarks}getIncompleteTaskValues(){return this.taskCollector.cache.incompleteMarks}getMark(){return E(this.app,this.taskCollector)}isComplete(t){return this.getCompletedTaskValues().contains(t)}isCanceled(t){return t==="-"}};var y=class extends C.Plugin{constructor(){super(...arguments);this.handlersRegistered=!1;this.commands=[]}async onload(){console.info("loading Task Collector (TC) v"+this.manifest.version),this.tc=new M,this.addSettingTab(new w(this.app,this,this.tc)),await this.loadSettings();let e={id:"task-collector-mark",name:"Mark task",icon:"check-square",editorCallback:async(s,a)=>{let o=await E(this.app,this.tc);if(o){let r=this.getCurrentLinesFromEditor(s);await this.editLines(o,r.lines),this.restoreCursor(r,s)}}};this.addCommand(e),this.registerHandlers(),this.api=new x(this.app,this.tc)}async markInCycle(e,s){let a=this.app.workspace.getActiveFile(),o=await this.app.vault.read(a),r=this.tc.markInCycle(o,e,s);await this.app.vault.modify(a,r)}async editLines(e,s){let a=this.app.workspace.getActiveFile(),o=await this.app.vault.read(a),r=this.tc.markSelectedTask(o,e,s);await this.app.vault.modify(a,r)}async collectTasks(){let e=this.app.workspace.getActiveFile(),s=await this.app.vault.read(e),a=this.tc.moveAllTasks(s);await this.app.vault.modify(e,a)}getCurrentLinesFromEditor(e){this.tc.logDebug("from: %o, to: %o, anchor: %o, head: %o, general: %o",e.getCursor("from"),e.getCursor("to"),e.getCursor("anchor"),e.getCursor("head"),e.getCursor());let s,a,o=[];if(e.somethingSelected()){s=e.getCursor("from"),a=e.getCursor("to");for(let r=s.line;r<=a.line;r++)o.push(r)}else s=e.getCursor(),o.push(s.line);return{start:s,end:a,lines:o}}buildContextMenu(e,s,a){this.tc.settings.contextMenu.markTask&&(e.addItem(o=>o.setTitle("(TC) Mark Task").setIcon("check-square").onClick(async()=>{this.tc.logDebug("Mark task",e,s,a);let r=await E(this.app,this.tc);r&&(await this.editLines(r,a.lines),this.restoreCursor(a,s.editor))})),this.tc.settings.markCycle&&(e.addItem(o=>o.setTitle("(TC) Mark with next").setIcon("forward").onClick(async()=>{this.tc.logDebug("Mark with next",e,s,a),await this.markInCycle(1,a.lines),this.restoreCursor(a,s.editor)})),e.addItem(o=>o.setTitle("(TC) Mark with previous").setIcon("reply").onClick(async()=>{this.tc.logDebug("Mark with previous",e,s,a),await this.markInCycle(0,a.lines),this.restoreCursor(a,s.editor)})))),Object.entries(this.tc.cache.marks).forEach(([o,r])=>{r.useContextMenu&&e.addItem(i=>i.setTitle(o===u?"(TC) Append text":`(TC) Mark with '${o}'`).setIcon("check-circle").onClick(async()=>{this.tc.logDebug(`Mark with '${o}'`,e,s,a),await this.editLines(o,a.lines),this.restoreCursor(a,s.editor)}))}),this.tc.settings.collectionEnabled&&this.tc.settings.contextMenu.collectTasks&&e.addItem(o=>o.setTitle("(TC) Collect tasks").setIcon("tornado").onClick(async()=>{await this.collectTasks(),this.restoreCursor(a,s.editor)}))}restoreCursor(e,s){e.lines.length>1?s.setSelection(e.start,e.end):s.setCursor(e.start)}registerHandlers(){if(!this.handlersRegistered){if(this.tc.logDebug("register handlers"),this.handlersRegistered=!0,this.tc.settings.collectionEnabled){let e={id:"task-collector-move-completed-tasks",name:"Collect tasks",icon:"tornado",callback:async()=>{this.collectTasks()}};this.addCommand(e),this.commands.push(e.id)}if(this.tc.settings.markCycle){let e={id:"task-collector-mark-next",name:"Mark with next",icon:"forward",editorCallback:(a,o)=>{this.tc.logDebug(`${s.id}: callback`,a,o)}};this.addCommand(e),this.commands.push(e.id);let s={id:"task-collector-mark-prev",name:"Mark with previous",icon:"reply",editorCallback:(a,o)=>{this.tc.logDebug(`${s.id}: callback`,a,o)}};this.addCommand(s),this.commands.push(s.id)}Object.entries(this.tc.cache.marks).forEach(([e,s])=>{if(s.registerCommand){let a={id:`task-collector-mark-task-${e}`,name:e==u?"Append text":`Mark with '${e}'`,icon:e==u?"list-plus":"check-circle",editorCallback:async(o,r)=>{let i=this.getCurrentLinesFromEditor(o);this.tc.logDebug(`${a.id}: callback`,i,o,r),await this.editLines(e,i.lines),this.restoreCursor(i,o)}};this.addCommand(a),this.commands.push(a.id)}}),this.tc.cache.useContextMenu&&this.registerEvent(this.editTaskContextMenu=this.app.workspace.on("editor-menu",async(e,s,a)=>{this.buildContextMenu(e,a,this.getCurrentLinesFromEditor(s))})),(this.tc.cache.useContextMenu||this.tc.settings.previewClickModal)&&this.registerMarkdownPostProcessor(this.postProcessor=(e,s)=>{let a=e.querySelectorAll(".task-list-item-checkbox");if(a.length){this.tc.logDebug("markdown postprocessor",e,s);for(let o of Array.from(a)){let r=s.getSectionInfo(o);if(!r)continue;let{lineStart:i}=r,c=Number(o.dataset.line);this.tc.cache.useContextMenu&&this.registerDomEvent(o.parentElement,"contextmenu",l=>{let p=this.app.workspace.getActiveViewOfType(C.MarkdownView);if(p){let k=new C.Menu;this.buildContextMenu(k,p,{start:{line:i+c,ch:0},lines:[i+c]}),k.showAtMouseEvent(l)}}),this.tc.settings.previewClickModal&&this.registerDomEvent(o,"click",async l=>{l.stopImmediatePropagation(),l.preventDefault();let p=await E(this.app,this.tc);p&&await this.editLines(p,[i+c]),l.stopImmediatePropagation(),l.preventDefault()})}}})}}unregisterHandlers(){this.tc.logDebug("unregister handlers"),this.handlersRegistered=!1,Object.keys(this.commands).forEach(e=>{this.app.commands.removeCommand(e),this.app.commands.removeCommand(`${this.manifest.id}:${e}`)}),console.log(this.app.commands),this.commands=[],this.editTaskContextMenu&&(this.app.workspace.offref(this.editTaskContextMenu),this.editTaskContextMenu=null),this.postProcessor&&(C.MarkdownPreviewRenderer.unregisterPostProcessor(this.postProcessor),this.postProcessor=null)}onunload(){console.log("unloading Task Collector")}async loadSettings(){let e=Object.assign({},await this.loadData());this.tc.init(await m.constructSettings(this,e))}async saveSettings(){this.tc.logDebug("save settings"),await this.saveData(this.tc.settings),this.handlersRegistered&&(this.unregisterHandlers(),this.registerHandlers())}};var le=y;

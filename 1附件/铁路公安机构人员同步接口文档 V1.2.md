# 铁路公安机构人员同步接口文档


## 1 接口要求

### 1.1 通信协议

采用无状态HTTPRestful风格，基于HTTP1.1协议，通过 POST/PUT/DELETE/GET方法调用，交互数据格式为JSON（既Content-type为“application/json”），交互数据使用UTF-8编码。

### 1.2 接口地址格式

地址为URL，格式：
http://[网络地址/域名]:[端口]/[上下文名称]/v[版本号]/[接口名称],其中：
“上下文”为模块名称，“网络地址”为IPv4格式，“端口”为阿拉伯数字，“版本号”为十进制阿拉伯数字。
样例1,验证应用凭证票据接口:http://20.3.1.156:8080/ua/v1/ verifyAppCredential.do

## 2 流程设计

1. 从铁路网关处获取appId、appSecret
2. 客户端生成签名信息
3. 网关登录，返回网关登录ID
4. 统一认证登录，返回统一认证登录ID
5. 第三方服务携带网关登录ID和统一认证ID访问业务接口

网关登录ID或统一认证登录ID超时失效后，访问业务接口会返回HTTP 401错误。第三方服务需要重新调用网关登录和统一认证登录。

## 3 接口规范

### 3.1. 签名信息生成【客户端逻辑】
- 参数信息
	- appId、appSecret、nonce、timestamp
- 返回内容
	- 签名信息
- 生成方法
	```
	  public static String sign(String appId, String appSecret, String nonce, String timestamp) {
    SecretKey key = new SecretKeySpec(appSecret.getBytes(StandardCharsets.UTF_8), "HMAC");
    try {
      Mac mac = Mac.getInstance("HmacSHA256");
      mac.init(key);
      String text = appId + nonce + timestamp;
      return Base64.getEncoder().encodeToString(mac.doFinal(text.getBytes(StandardCharsets.UTF_8)));
    } catch (NoSuchAlgorithmException | InvalidKeyException e) {
      throw new IllegalStateException(e);
    }
  }
	```

### 3.2. 登录

#### Request
- URL:  ```/gateway/login/mag/mag/v1/login```
- Method: **POST**
- Headers：
	- Content-Type: **application/x-www-form-urlencoded**

- 请求范例：
```bash
curl --location --request POST 'https://192.168.11.60:5402/gateway/login/mag/mag/v1/login?appId=com.pekall.testapp&nonce=123456&timestamp=1651025229000&sign=fZzXHGRuX%2B8b3Xa7%2FGhzlPHx8ZLtJHe%2BPJ9ltTd0VC8%3D'
```

#### Response

- 响应范例：
- 请求成功, 返回网关登录ID
```
{"errorCode":"0","description":"success","loginId":"eyJhbGciOiJFUzI1NiIsImp3ayI6eyJrdHkiOiJFQyIsImNydiI6IlAtMjU2IiwieCI6IkJ4bm9KejFQdVBiOTRKZlFFSmNDMGhjM1pTZmFKMTF4OFkxczFZelU2RWciLCJ5IjoiWXZzRWo3cGJJR2ZYZDFtZmlWSUdMSnhEOWowVm1xYVBaMDJudEZpNk1sTSIsImFsZyI6IkVTMjU2In19.eyJhdWQiOiJtYWcucGVrYWxsLmNvbSIsInN1YiI6ImNvbS5wZWthbGwudGVzdGFwcCIsIm5iZiI6MTY1MjE0NTE1MCwiaXNzIjoiaHR0cHM6XC9cL3d3dy5wZWthbGwuY29tIiwiZXhwIjoxNjUyMTQ2OTUwLCJpYXQiOjE2NTIxNDUxNTB9.ege99aRnnhZi0w_IsCSpSYZUHmPMNyVzaIZv0ryDk4J2mi6yCr1eobDxCQgGjCOO_NzjVNZ7o3xs23J78hd-tQ"}
```

- 请求失败:
```
{"errorCode":"-1","description":"app not found"}
```


### 3.3. 统一认证登录

#### Request
- URL:  ```/gateway/mag/railway.sync/uni_auth/v1/login/gateway```
- Method: **POST**
- Headers：
	- Content-Type: **application/x-www-form-urlencoded**
	- Authorization: Bearer **网关登录ID**
- Body:
	- authenticationMethod: 认证方法，固定填写"PASSWORD"
	- vendor: 认证提供商， 固定填写"PEKALL"
	- parameters: 认证参数，格式如下:
		- ``` {"userName":"用户名", "password":"密码"} ```
- 请求范例：
```bash
curl --location -g --request POST 'https://192.168.11.60:5402/gateway/mag/railway.sync/uni_auth/v1/login/gateway?authenticationMethod=PASSWORD&vendor=PEKALL&parameters={"userName":"test", "password":"test"}' \
--header 'Authorization: Bearer eyJhbGciOiJFUzI1NiIsImp3ayI6eyJrdHkiOiJFQyIsImNydiI6IlAtMjU2IiwieCI6IkJ4bm9KejFQdVBiOTRKZlFFSmNDMGhjM1pTZmFKMTF4OFkxczFZelU2RWciLCJ5IjoiWXZzRWo3cGJJR2ZYZDFtZmlWSUdMSnhEOWowVm1xYVBaMDJudEZpNk1sTSIsImFsZyI6IkVTMjU2In19.eyJhdWQiOiJtYWcucGVrYWxsLmNvbSIsInN1YiI6ImNvbS5wZWthbGwudGVzdGFwcCIsIm5iZiI6MTY1MjA4OTExMiwiaXNzIjoiaHR0cHM6XC9cL3d3dy5wZWthbGwuY29tIiwiZXhwIjoxNjUyMDkwOTEyLCJpYXQiOjE2NTIwODkxMTJ9.W5gSZXTq9gExd3X0vy4jkSPeSpfnEpUokiBSatp-FjqcYSSm2Lz1qNb-ieCSKKcG3IPMJl1JZzPMXY7E8-C2pw'
```

#### Response
- Headers：
	- Content-Type: **application/json**
- Body:
	- errorCode: "0"为成功，其他为失败
	- description: 描述信息
	- loginId: 登录ID, 仅仅在errorCode为"0"时返回

- 响应范例：
- 请求成功
```
HTTP/1.1 200 OK
{
  "errorCode": "0",
  "description": "登陆成功",
  "loginId": "0cf629af1f0d40a3bbf39f06474e478e"
}
```

- 请求失败:
```
HTTP/1.1 200 OK
{
  "errorCode": "AUTHENTICATION_USER_PASSWORD_INCORRECT",
  "description": "用户的密码错误"
}
```


### 3.4. 获取机构操作事件信息接口

本接口按照时间顺序返回机构的操作事件，如机构创建，更新或删除。

#### Request
- URL:  ```/gateway/mag/railway.sync/uni_auth/v1/info_sync/org_event```
- Method: **GET**
- Headers：
	- loginId: 统一认证登录接口返回的loginId
	- Authorization: Bearer **网关登录ID**
- Parameter:
	- pageNum: 页号，从1开始
	- pageSize: 页大小, 大于等于1
	- eventTime: 事件时间，epoch毫秒数。
		- 第一次调用时不传递
		- 第二次调用时传递上次收到响应中最后一个机构的eventTime
			- 接口将返回这个时间点之后的所有操作事件
- 请求范例：
```bash
curl --location --request GET 'https://192.168.11.60:5402/gateway/mag/railway.sync/uni_auth/v1/info_sync/org_event?pageNum=1&pageSize=10&eventTime=1642501386000' \
--header 'Authorization: Bearer eyJhbGciOiJFUzI1NiIsImp3ayI6eyJrdHkiOiJFQyIsImNydiI6IlAtMjU2IiwieCI6IkJ4bm9KejFQdVBiOTRKZlFFSmNDMGhjM1pTZmFKMTF4OFkxczFZelU2RWciLCJ5IjoiWXZzRWo3cGJJR2ZYZDFtZmlWSUdMSnhEOWowVm1xYVBaMDJudEZpNk1sTSIsImFsZyI6IkVTMjU2In19.eyJhdWQiOiJtYWcucGVrYWxsLmNvbSIsInN1YiI6ImNvbS5wZWthbGwudGVzdGFwcCIsIm5iZiI6MTY1MjA4OTExMiwiaXNzIjoiaHR0cHM6XC9cL3d3dy5wZWthbGwuY29tIiwiZXhwIjoxNjUyMDkwOTEyLCJpYXQiOjE2NTIwODkxMTJ9.W5gSZXTq9gExd3X0vy4jkSPeSpfnEpUokiBSatp-FjqcYSSm2Lz1qNb-ieCSKKcG3IPMJl1JZzPMXY7E8-C2pw' \
--header 'loginId: 1696b113eaa24f48819ae0290dac553e'
```

#### Response
- Headers：
	- Content-Type: **application/json**
- Body:
	- totalCount: 机构总数
	- pageCount: 分页总数
	- contentList: 机构事件列表
		- isDelete: 操作事件类型。0：创建或更新事件，1：删除事件
		- eventTime: 机构操作事件时间，单位为epoch毫秒数
		- orgId： 机构ID, 机构的唯一标识
		- name: 机构名称
		- abbreviation: 机构简称
		- orgCodeReal: 机构编码
		- parentOrgId: 父机构ID。删除事件无父机构ID

- 响应范例：
- 请求成功
```
HTTP/1.1 200 OK
{  
  "pageCount": 1,  
  "contentList": [  
    {  
      "id": "f75029f1781011ecba79fa163e9b955d",  
      "name": "铁路公安同步测试机构",  
      "abbreviation": "铁路公安同步测试机构",  
      "orgCodeReal": "railway_sync",  
      "parentOrgCodeReal": "911239dc5d3e11e6a468ec55f9c7f785",  
      "eventTime": 1642477480000
 },  
    {  
      "id": "49e1c42e782611ecba79fa163e9b955d",  
      "name": "test1",  
      "abbreviation": "test1",  
      "orgCodeReal": "test1",  
      "parentOrgCodeReal": "railway_sync",  
      "eventTime": 1642486639000  
 }  
  ],  
  "totalCount": 2  
}
```

- 请求失败:
```
HTTP/1.1 401 Unauthorized
content-length: 14
content-type: text/plain
date: Mon, 09 May 2022 09:14:34 GMT
server: mag

Jwt is expired%
```

### 3.5. 获取用户操作事件信息

本接口按照时间顺序返回用户的操作事件，如用户创建，更新或删除。

#### Request
- URL:  ```/gateway/mag/uni_auth/v1/info_sync/user_event```
- Method: **GET**
- Headers：
	- Authorization: Bearer **网关登录ID**
	- loginId: 统一认证登录接口返回的loginId
- Parameter:
	- pageNum: 页号，从1开始
	- pageSize: 页大小, 大于等于1
	- eventTime: 用户操作事件事件，epoch毫秒数。
		- 第一次调用时不传递
		- 第二次调用时传递上次收到响应中最后一个机构的eventTime
			- 接口将返回这个时间点之后的所有操作事件
- 请求范例：
```bash
curl --location --request GET 'https://192.168.11.60:5402/gateway/mag/railway.sync/uni_auth/v1/info_sync/user_event?pageNum=1&pageSize=10' \
--header 'Authorization: Bearer eyJhbGciOiJFUzI1NiIsImp3ayI6eyJrdHkiOiJFQyIsImNydiI6IlAtMjU2IiwieCI6IkJ4bm9KejFQdVBiOTRKZlFFSmNDMGhjM1pTZmFKMTF4OFkxczFZelU2RWciLCJ5IjoiWXZzRWo3cGJJR2ZYZDFtZmlWSUdMSnhEOWowVm1xYVBaMDJudEZpNk1sTSIsImFsZyI6IkVTMjU2In19.eyJhdWQiOiJtYWcucGVrYWxsLmNvbSIsInN1YiI6ImNvbS5wZWthbGwudGVzdGFwcCIsIm5iZiI6MTY1MjA4OTExMiwiaXNzIjoiaHR0cHM6XC9cL3d3dy5wZWthbGwuY29tIiwiZXhwIjoxNjUyMDkwOTEyLCJpYXQiOjE2NTIwODkxMTJ9.W5gSZXTq9gExd3X0vy4jkSPeSpfnEpUokiBSatp-FjqcYSSm2Lz1qNb-ieCSKKcG3IPMJl1JZzPMXY7E8-C2pw' \
--header 'loginId: 1696b113eaa24f48819ae0290dac553e'
```

#### Response
- Headers：
	- Content-Type: **application/json**
- Body:
	- totalCount: 机构总数
	- pageCount: 分页总数
	- contentList: 机构列表
		- isDelete: 操作事件类型。0：创建或更新事件, 1：删除事件
		- eventTime: 用户操作事件时间，单位为epoch毫秒数
		- userId： 用户ID
		- name： 用户名称
		- account: 账号
		- policeNum: 警号
		- idNum: 身份证号
		- mobilePhone: 手机号
		- orgName: 机构全称
		- orgId: 所属机构ID
		- officePhone: 办公室电话

- 响应范例：
- 请求成功
```
HTTP/1.1 200 OK
{  
  "pageCount": 1,  
  "contentList": [  
    {  
      "id": "ff8080817e6c3cca017e6c405f260000",  
      "name": "test1",  
      "account": "test1",  
      "policeNum": "001208",  
      "idNum": "110103198006160037",  
      "mobilePhone": "15001187961",  
      "orgName": "test1",  
      "orgCode": "49e1c42e782611ecba79fa163e9b955d",  
      "officePhone": "18209310989",  
      "eventTime": 1642493665000
 }  
  ],  
  "totalCount": 1  
}
```

- 请求失败:
```
HTTP/1.1 401 Unauthorized
content-length: 14
content-type: text/plain
date: Mon, 09 May 2022 09:14:34 GMT
server: mag

Jwt is expired%
```



#todo 铁路公安导出脚本编写
- 登录，在线，核查，核录，【北京，天津，石家庄，神华，局机关】【机关数，前top十，后top十】
- 离线超过30天未使用的情况统计
详见Excel，按==局机关各科室、直属单位==，北京处，天津处，石家庄处，神华处分开统计。


- 各应用系统使用情况
X月X日至X月X日，经对全局移动警务终端各系统使用情况进行数据分析
北京铁路公安移动警务平台共==上线==1X个移动警务应用，应用==累计下载==1万5千余次，==累计使用点击==XXX万余次。==本月下载量前五名==的移动应用为：京铁警信（57次）、核查系统（29次）、接处警综合系统（7次）、证照查验（6次）、加密对讲PDDS（2次）。==本月点击量前五名==的移动应用为：京铁警信（500次）、核查系统（387次）、接处警综合系统（195次）、证照查验（131次）、加密对讲PDDS（58次）；==各单位本月点击量排名==:北京处（62046次）、天津处（49255次）、石家庄处（30641次）、神华处（15670次）、局机关（13424次）；
全局主要==实战单位领导终端使用情况==

#todo poca的ios环境准备，调试 
	- enroll 需要增加票据参数--完成
	- 客户端需要重新出包，然后测试
#todo bug修改： 26386，26378，26292（确定原因），26241（确定现场是否已升级：未升级），26237，26232（确定原因），25779（权限问题），25772（权限问题）
#todo 文档修改---------完成
#todo 整理标准版ios相关接口------完成
#todo 确定使用玉强的poca，需要修改的内容，发送邮件------完成


![[ios客户端接口.xlsx]]
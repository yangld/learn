	任务: 关联分析设计整理
	项目: 湖南省集中管控
	阶段: 详细设计
	输入: 代码
	输出: 设计文档, 未完成功能说明

1. 模块关系图
	1. 步骤0, 开启安全管理/关联分析规则, 关联分析事件响应规则
	2. 步骤1, 接收coll上报的设备注册, 资源使用, 应用使用, 用户登录信息
	3. 步骤2, 将上述日志写入到es中
	4. 步骤3, 同时写入kafka中
	5. 步骤4, AA-FLINK读取kafka中的日志信息,处理数据后
	6. 步骤5, 写入处理数据到kafka
	7. 步骤6, cmc从kafka中读取处理数据
	8. 步骤7, 写入mysql中
	9. 步骤8,web端查看关联分析事件日志
	10. 步骤9,读取关联分析响应规则
	11. 步骤10, 根据规则,确定是否写入关联分析响应日志
	12. 步骤11, 查询关联分析响应日志

	![[模块关系图 2.jpg]]

2. cmc记录原始数据到kafka
	![[时序图.jpg]]

3. aa处理kafka原始数据,并生成事件数据到kafka
	![[AA时序图.jpg]]

1. cmc接收数据,并写入mysql, 并触发事件响应日志处理逻辑
	![[cmc接收事件 1.jpg]]

1. AA处理逻辑依赖的ER
	1. data_type_mapping 有topic_name和data_type, 及转换类
	2. associ_analysis_rule_group 有开关, object_type, event_type
	3. associ_analysis_rule有data_type, 分析器的类名
	```mermaid
	erDiagram
		ASSOCI_ANALYSIS_RULE_GROUP  ||--|{ ASSOCI_ANALYSIS_RULE: one-to-many
		DATA_TYPE_MAPPING		    ||--|{ 	ASSOCI_ANALYSIS_RULE:one-to-many
		
		ASSOCI_ANALYSIS_EVENT	
		
		
		ASSOCI_ANALYSIS_RULE {
			string analyzer_class
			string analyzer_jar_url
			string message_template
			string rule_group_id
			string name
	        string data_type
			string id
		}
		
		ASSOCI_ANALYSIS_RULE_GROUP {
		    string description
	        string object_type
	        string is_enabled
	        string event_type
		    string name
			string id
	    }
	
		DATA_TYPE_MAPPING {
		    string topic_name
			string data_type
			string mapping_type
			string expression
			string converter
			string id
	    }
		
		ASSOCI_ANALYSIS_EVENT {
		    string event_type
		    string log_id
		    string message
		    date   occocur_time
		    string terminal_id
		    string terminal_name
		    string user_id
		    string user_name
		    string confirmation_status
		    string confirmation_user_name
		    date   confirmation_time
		    string event_object_type
		    string event_object_name
	        string event_object_id
			string id
	    }
	```


1. cmc处理关联分析通知逻辑
	1. action的code对应处理的类,处理的类包含通知管理员, 注销设备, 停用用户,关闭vpn
	2. event_source的souce_type是入口,根据处理的对象是那种类型的,找到对应的处理action
	3. action_rule_actions 是开关, 确定关联分析事件, 应该有哪些相应动作,如果事件没有对应的动作, 则不执行动作,忽略该事件
	4. associ_analysis_event是数据,里面有用户,设备, 管理员,时间等信息,给生成关联分析回复日志提供数据来源

	```mermaid
	erDiagram
		ACTION  		        ||--|{ 	ACTION_RULE_ACTIONS	    : one-to-many
	    ACTION_RULE 			||--|{ 	ACTION_RULE_ACTIONS		: one-to-many
		EVENT_SOURCE			||--|{ 	ACTION_RULE	            : one-to-many
		
		ASSOCI_ANALYSIS_EVENT	
		
		
		ACTION {
			string code
			string name
	        string description
			string id
		}
		
		ACTION_RULE {
		    string event_type
		    string event_source_id
			string id
	    }
		ACTION_RULE_ACTIONS {
	        string id
			string rule_id
			string action_id
	    }
		EVENT_SOURCE {
		    string source_type
			string source_name
			string id
	    }
		
		ASSOCI_ANALYSIS_EVENT {
		    string event_type
		    string log_id
		    string message
		    date   occocur_time
		    string terminal_id
		    string terminal_name
		    string user_id
		    string user_name
		    string confirmation_status
		    string confirmation_user_name
		    date   confirmation_time
		    string event_object_type
		    string event_object_name
	        string event_object_id
			string id
	    }
	```

1. 任务完成情况
	1. 未完成功能
		1. vpn日志的接收逻辑, 跟姜睿确认, vpn日志之前是从syslog中获取,然后放到kafka中
		2. 事件响应逻辑中,通知管理员逻辑未实现,只有接口
		3. 事件响应逻辑中, 禁止接入VPN逻辑没有
		4. web端没有关联分析响应日志的查看页面
	2. 已完成功能
		1. 查看AA代码逻辑并修改
		2. 查看cmc的逻辑, 支持用户登录日志进kafka
		3. 修改AA使用的mysql版本为8.0
		4. 将AA功能移动到cmc_info_server中
		5. 修改打包脚本,将AA逻辑增加到打包逻辑中
		6. 在150上进行基本功能测试,生成数据完成,可以开始测试